{% extends "base.html" %}

{% block title %}Dashboard - Kostal Battery Manager{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Status Overview -->
    <div class="card status-card">
        <h2>ğŸ“Š Status-Ãœbersicht</h2>
        <div class="status-grid">
            <div class="status-item">
                <span class="label">Verbindung:</span>
                <span class="value connection-status" id="connection-status">
                    <span class="dot"></span> PrÃ¼fe...
                </span>
            </div>
            <div class="status-item">
                <span class="label">Modus:</span>
                <span class="value" id="mode">{{ state.inverter.mode }}</span>
            </div>
            <div class="status-item">
                <span class="label">Steuerung:</span>
                <span class="value" id="control-mode">{{ state.inverter.control_mode }}</span>
            </div>
            <div class="status-item">
                <span class="label">Letzte Aktualisierung:</span>
                <span class="value" id="last-update">{{ state.last_update or 'Noch nie' }}</span>
            </div>
        </div>
    </div>

    <!-- Battery Status -->
    <div class="card battery-card">
        <h2>ğŸ”‹ Batterie</h2>
        <div class="battery-display">
            <div class="battery-icon">
                <div class="battery-level" id="battery-level" style="width: {{ state.battery.soc }}%"></div>
            </div>
            <div class="battery-info">
                <div class="battery-soc">
                    <span class="big-number" id="battery-soc">{{ state.battery.soc }}</span>
                    <span class="unit">%</span>
                </div>
                <div class="battery-power">
                    <span id="battery-power">{{ state.battery.power }}</span> W
                </div>
            </div>
        </div>
        <div class="battery-details">
            <div>KapazitÃ¤t: {{ config.battery_capacity }} kWh</div>
            <div>Min SOC: {{ config.min_soc }}% | Max SOC: {{ config.max_soc }}%</div>
        </div>
    </div>

    <!-- Price Information -->
    <div class="card price-card">
        <h2>ğŸ’° Strompreis</h2>
        <div class="price-display">
            <div class="current-price">
                <span class="label">Aktuell:</span>
                <span class="big-number" id="current-price">{{ "%.4f"|format(state.price.current) }}</span>
                <span class="unit">â‚¬/kWh</span>
            </div>
            <div class="price-level">
                <span class="badge" id="price-level">{{ state.price.level }}</span>
            </div>
        </div>
        <div class="price-info">
            <div>Durchschnitt: <span id="avg-price">{{ "%.4f"|format(state.price.average) }}</span> â‚¬/kWh</div>
            <div>Schwelle: {{ (config.price_threshold * 100)|int }}%</div>
        </div>
    </div>

    <!-- Manual Control -->
    <div class="card control-card">
        <h2>ğŸ›ï¸ Manuelle Steuerung</h2>
        <div class="control-buttons">
            <button onclick="startCharging()" class="btn btn-primary">
                â–¶ï¸ Laden starten
            </button>
            <button onclick="stopCharging()" class="btn btn-secondary">
                â¹ï¸ Laden stoppen
            </button>
            <button onclick="autoMode()" class="btn btn-success">
                ğŸ”„ Automatik
            </button>
            <button onclick="testConnection()" class="btn btn-info">
                ğŸ”Œ Verbindung testen
            </button>
        </div>
        <div class="power-slider">
            <label for="charge-power">Ladeleistung: <span id="power-display">{{ config.max_charge_power }}</span> W</label>
            <input type="range"
                   id="charge-power"
                   min="500"
                   max="{{ config.max_charge_power }}"
                   step="100"
                   value="{{ config.max_charge_power }}"
                   oninput="document.getElementById('power-display').textContent = this.value"
                   onchange="adjustPowerIfCharging(this.value)">
        </div>
        <button onclick="syncSocLimits()" class="btn btn-warning" style="margin-top: 1rem;">
            ğŸ”„ SOC Limits synchronisieren
        </button>
    </div>

    <!-- Forecast -->
    <div class="card forecast-card">
        <h2>â˜€ï¸ PV Prognose</h2>
        <div class="forecast-display">
            <div class="forecast-item">
                <span class="label">Heute:</span>
                <span class="value" id="forecast-today">{{ "%.1f"|format(state.forecast.today) }} kWh</span>
            </div>
            <div class="forecast-item">
                <span class="label">Morgen:</span>
                <span class="value" id="forecast-tomorrow">{{ "%.1f"|format(state.forecast.tomorrow) }} kWh</span>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="card stats-card">
        <h2>ğŸ“ˆ Statistik (Coming Soon)</h2>
        <p>Hier werden Charts zu Preisen, Batterieladung und Verbrauch angezeigt...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Helper functions - defined here to avoid dependency on app.js
function showLoading(message = 'LÃ¤dt...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-size: 1.2rem;
    `;
    loadingDiv.innerHTML = `<div style="text-align: center;">${message}</div>`;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function showNotification(type, message, duration = 3000) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 10000;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, duration);
}

// Auto-refresh status every 10 seconds
let refreshInterval = setInterval(updateStatus, 10000);
updateStatus();

function updateStatus() {
    fetch('api/status')
        .then(response => response.json())
        .then(data => {
            // Update connection status
            const connStatus = document.getElementById('connection-status');
            if (data.inverter.connected) {
                connStatus.innerHTML = '<span class="dot connected"></span> Verbunden';
                connStatus.className = 'value connection-status connected';
            } else {
                connStatus.innerHTML = '<span class="dot disconnected"></span> Getrennt';
                connStatus.className = 'value connection-status disconnected';
            }
            
            // Update mode
            document.getElementById('mode').textContent = data.inverter.mode;
            document.getElementById('control-mode').textContent = data.inverter.control_mode;
            
            // Update battery
            const soc = data.battery.soc || 0;
            document.getElementById('battery-soc').textContent = soc;
            document.getElementById('battery-level').style.width = soc + '%';
            document.getElementById('battery-power').textContent = data.battery.power || 0;
            
            // Update price
            document.getElementById('current-price').textContent = (data.price.current || 0).toFixed(4);
            document.getElementById('avg-price').textContent = (data.price.average || 0).toFixed(4);
            document.getElementById('price-level').textContent = data.price.level || 'Unbekannt';
            
            // Update forecast
            document.getElementById('forecast-today').textContent = (data.forecast.today || 0).toFixed(1) + ' kWh';
            document.getElementById('forecast-tomorrow').textContent = (data.forecast.tomorrow || 0).toFixed(1) + ' kWh';
            
            // Update timestamp
            const timestamp = new Date(data.timestamp);
            document.getElementById('last-update').textContent = timestamp.toLocaleString('de-DE');
        })
        .catch(error => {
            console.error('Error updating status:', error);
        });
}

function startCharging() {
    const power = document.getElementById('charge-power').value;
    
    if (confirm(`Batterie mit ${power}W laden?`)) {
        showLoading('Starte Ladung...');
        
        fetch('api/control', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'start_charging', power: parseInt(power)})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            showNotification('success', 'Ladung gestartet!');
            updateStatus();
        })
        .catch(error => {
            hideLoading();
            showNotification('error', 'Fehler beim Starten der Ladung');
            console.error(error);
        });
    }
}

function stopCharging() {
    if (confirm('Ladung stoppen und zurÃ¼ck zur internen Steuerung?')) {
        showLoading('Stoppe Ladung...');
        
        fetch('api/control', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'stop_charging'})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            showNotification('success', 'Ladung gestoppt');
            updateStatus();
        })
        .catch(error => {
            hideLoading();
            showNotification('error', 'Fehler beim Stoppen');
            console.error(error);
        });
    }
}

function autoMode() {
    showLoading('Aktiviere Automatik...');
    
    fetch('api/control', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'auto_mode'})
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        showNotification('success', 'Automatik-Modus aktiviert');
        updateStatus();
    })
    .catch(error => {
        hideLoading();
        showNotification('error', 'Fehler beim Aktivieren der Automatik');
        console.error(error);
    });
}

function testConnection() {
    showLoading('Teste Verbindung...');

    fetch('api/control', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'test_connection'})
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        updateStatus();
    })
    .catch(error => {
        hideLoading();
        showNotification('error', 'Verbindungstest fehlgeschlagen');
        console.error(error);
    });
}

// v0.2.0: Adjust power during active charging
function adjustPowerIfCharging(power) {
    // Check if currently charging
    fetch('api/status')
        .then(response => response.json())
        .then(data => {
            if (data.inverter.mode === 'manual_charging' || data.inverter.mode === 'auto_charging') {
                // Adjust power
                fetch('api/adjust_power', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({power: parseInt(power)})
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'ok') {
                        showNotification('success', `Ladeleistung auf ${power}W angepasst`);
                    } else {
                        showNotification('error', 'Fehler beim Anpassen der Leistung');
                    }
                })
                .catch(error => {
                    console.error('Error adjusting power:', error);
                    showNotification('error', 'Fehler beim Anpassen der Leistung');
                });
            }
        })
        .catch(error => console.error('Error checking status:', error));
}

// v0.2.0: Synchronize SOC limits to inverter
function syncSocLimits() {
    if (confirm('SOC Limits zum Wechselrichter synchronisieren?')) {
        showLoading('Synchronisiere SOC Limits...');

        fetch('api/sync_soc', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.status === 'ok') {
                showNotification('success', data.message);
            } else {
                showNotification('error', data.message || 'Fehler beim Synchronisieren');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('error', 'Fehler beim Synchronisieren der SOC Limits');
            console.error(error);
        });
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    clearInterval(refreshInterval);
});
</script>
{% endblock %}