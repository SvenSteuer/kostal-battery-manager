{% extends "base.html" %}

{% block title %}Dashboard - Kostal Battery Manager{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Status Overview -->
    <div class="card status-card">
        <h2>üìä Status-√úbersicht</h2>
        <div class="status-grid">
            <div class="status-item">
                <span class="label">Verbindung:</span>
                <span class="value connection-status" id="connection-status">
                    <span class="dot"></span> Pr√ºfe...
                </span>
            </div>
            <div class="status-item">
                <span class="label">Automatik:</span>
                <span class="value" id="auto-status">
                    <span class="dot connected"></span> AN
                </span>
            </div>
            <div class="status-item">
                <span class="label">Status:</span>
                <span class="value" id="status">Standby</span>
            </div>
            <div class="status-item">
                <span class="label">Letzte Aktualisierung:</span>
                <span class="value" id="last-update">{{ state.last_update or 'Noch nie' }}</span>
            </div>
        </div>
    </div>

    <!-- Battery Status -->
    <div class="card battery-card">
        <h2>üîã Batterie</h2>
        <div class="battery-display">
            <div class="battery-icon">
                <div class="battery-level" id="battery-level" style="width: {{ state.battery.soc }}%"></div>
            </div>
            <div class="battery-info">
                <div class="battery-soc">
                    <span class="big-number" id="battery-soc">{{ state.battery.soc }}</span>
                    <span class="unit">%</span>
                </div>
                <div class="battery-power" id="battery-power-status">
                    Batterie in Standby
                </div>
            </div>
        </div>
        <div class="battery-details">
            <div>Kapazit√§t: {{ config.battery_capacity }} kWh</div>
            <div>Sicherheits-SOC: {{ config.auto_safety_soc }}% | Lade-Limit: {{ config.auto_charge_below_soc }}%</div>
        </div>
    </div>

    <!-- Price Information -->
    <div class="card price-card">
        <h2>üí∞ Strompreis</h2>
        <div class="price-display">
            <div class="current-price">
                <span class="label">Aktuell:</span>
                <span class="big-number" id="current-price">{{ "%.2f"|format(state.price.current * 100) }}</span>
                <span class="unit">Cent/kWh</span>
            </div>
            <div class="price-level">
                <span class="badge" id="price-level">{{ state.price.level }}</span>
            </div>
        </div>
        <div class="price-info">
            <div>Durchschnitt: <span id="avg-price">{{ "%.2f"|format(state.price.average * 100) }}</span> Cent/kWh</div>
            <div>Schwelle: {{ (config.price_threshold * 100)|int }}%</div>
        </div>
    </div>

    <!-- Manual Control -->
    <div class="card control-card">
        <h2>üéõÔ∏è Manuelle Steuerung</h2>
        <div class="control-buttons">
            <button onclick="startCharging()" class="btn btn-primary">
                ‚ñ∂Ô∏è Laden starten
            </button>
            <button onclick="stopCharging()" class="btn btn-secondary">
                ‚èπÔ∏è Laden stoppen
            </button>
            <div class="automation-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-toggle" onchange="toggleAutomation(this.checked)" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">üîÑ Automatik</span>
            </div>
        </div>
        <div class="power-slider">
            <label for="charge-power">Ladeleistung: <span id="power-display">{{ config.max_charge_power }}</span> W</label>
            <input type="range"
                   id="charge-power"
                   min="500"
                   max="{{ config.max_charge_power }}"
                   step="100"
                   value="{{ config.max_charge_power }}"
                   oninput="document.getElementById('power-display').textContent = this.value"
                   onchange="adjustPowerIfCharging(this.value)">
        </div>
    </div>

    <!-- Forecast -->
    <div class="card forecast-card">
        <h2>‚òÄÔ∏è PV Prognose</h2>
        <div class="forecast-display">
            <div class="forecast-item">
                <span class="label">Heute:</span>
                <span class="value" id="forecast-today">{{ "%.1f"|format(state.forecast.today) }} kWh</span>
            </div>
            <div class="forecast-item">
                <span class="label">Morgen:</span>
                <span class="value" id="forecast-tomorrow">{{ "%.1f"|format(state.forecast.tomorrow) }} kWh</span>
            </div>
        </div>
    </div>

    <!-- Charging Plan (v0.3.0) -->
    <div class="card forecast-card">
        <h2>üìÖ Geplante Ladung</h2>
        <div class="forecast-display" id="charging-plan-display">
            <div class="forecast-item">
                <span class="label">Start:</span>
                <span class="value" id="plan-start">Nicht geplant</span>
            </div>
            <div class="forecast-item">
                <span class="label">Ende:</span>
                <span class="value" id="plan-end">Nicht geplant</span>
            </div>
            <div class="forecast-item">
                <span class="label">Berechnet:</span>
                <span class="value" id="plan-calculated">Nie</span>
            </div>
        </div>
        <div style="margin-top: 1rem;">
            <button onclick="recalculatePlan()" class="btn btn-secondary" style="width: 100%;">
                üîÑ Neu berechnen
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="card stats-card">
        <h2>üìà Statistik (Coming Soon)</h2>
        <p>Hier werden Charts zu Preisen, Batterieladung und Verbrauch angezeigt...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Helper functions - defined here to avoid dependency on app.js
function showLoading(message = 'L√§dt...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-size: 1.2rem;
    `;
    loadingDiv.innerHTML = `<div style="text-align: center;">${message}</div>`;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function showNotification(type, message, duration = 3000) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 10000;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, duration);
}

// Auto-refresh status every 2 seconds (v0.2.1)
let refreshInterval = setInterval(updateStatus, 2000);
updateStatus();

function updateStatus() {
    fetch('api/status')
        .then(response => response.json())
        .then(data => {
            // Update connection status
            const connStatus = document.getElementById('connection-status');
            if (data.inverter.connected) {
                connStatus.innerHTML = '<span class="dot connected"></span> Verbunden';
                connStatus.className = 'value connection-status connected';
            } else {
                connStatus.innerHTML = '<span class="dot disconnected"></span> Getrennt';
                connStatus.className = 'value connection-status disconnected';
            }

            // v0.2.5 - Update automation status
            const autoStatus = document.getElementById('auto-status');
            const autoToggle = document.getElementById('auto-toggle');
            if (data.controller_running) {
                autoStatus.innerHTML = '<span class="dot connected"></span> AN';
                autoToggle.checked = true;
            } else {
                autoStatus.innerHTML = '<span class="dot disconnected"></span> AUS';
                autoToggle.checked = false;
            }

            // v0.2.6 - Update status with German labels
            const statusElement = document.getElementById('status');
            const mode = data.inverter.mode;
            if (mode === 'automatic') {
                statusElement.textContent = 'Standby';
            } else if (mode === 'manual_charging') {
                statusElement.textContent = 'L√§dt (manuell)';
            } else if (mode === 'auto_charging') {
                statusElement.textContent = 'L√§dt (Auto)';
            } else {
                statusElement.textContent = mode;
            }
            
            // Update battery
            const soc = data.battery.soc || 0;
            document.getElementById('battery-soc').textContent = soc;
            document.getElementById('battery-level').style.width = soc + '%';

            // Update battery power status
            const batteryPower = data.battery.power || 0;
            const batteryStatus = document.getElementById('battery-power-status');
            if (batteryPower > 0) {
                batteryStatus.textContent = `Batterie wird entladen: ${Math.round(batteryPower)} W`;
            } else if (batteryPower < 0) {
                batteryStatus.textContent = `Batterie wird geladen: ${Math.round(Math.abs(batteryPower))} W`;
            } else {
                batteryStatus.textContent = 'Batterie in Standby';
            }

            // Update price (convert to cents)
            document.getElementById('current-price').textContent = ((data.price.current || 0) * 100).toFixed(2);
            document.getElementById('avg-price').textContent = ((data.price.average || 0) * 100).toFixed(2);
            document.getElementById('price-level').textContent = data.price.level || 'Unbekannt';
            
            // Update forecast
            document.getElementById('forecast-today').textContent = (data.forecast.today || 0).toFixed(1) + ' kWh';
            document.getElementById('forecast-tomorrow').textContent = (data.forecast.tomorrow || 0).toFixed(1) + ' kWh';

            // v0.3.0 - Update charging plan
            if (data.charging_plan && data.charging_plan.planned_start) {
                const startTime = new Date(data.charging_plan.planned_start);
                const endTime = new Date(data.charging_plan.planned_end);
                const calculated = new Date(data.charging_plan.last_calculated);

                document.getElementById('plan-start').textContent = startTime.toLocaleString('de-DE', {hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit'});
                document.getElementById('plan-end').textContent = endTime.toLocaleString('de-DE', {hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit'});
                document.getElementById('plan-calculated').textContent = calculated.toLocaleString('de-DE', {hour: '2-digit', minute: '2-digit'});
            } else {
                document.getElementById('plan-start').textContent = 'Nicht geplant';
                document.getElementById('plan-end').textContent = 'Nicht geplant';
                document.getElementById('plan-calculated').textContent = 'Nie';
            }

            // Update timestamp
            const timestamp = new Date(data.timestamp);
            document.getElementById('last-update').textContent = timestamp.toLocaleString('de-DE');
        })
        .catch(error => {
            console.error('Error updating status:', error);
        });
}

function startCharging() {
    const power = document.getElementById('charge-power').value;
    
    if (confirm(`Batterie mit ${power}W laden?`)) {
        showLoading('Starte Ladung...');
        
        fetch('api/control', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'start_charging', power: parseInt(power)})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            showNotification('success', 'Ladung gestartet!');
            updateStatus();
        })
        .catch(error => {
            hideLoading();
            showNotification('error', 'Fehler beim Starten der Ladung');
            console.error(error);
        });
    }
}

function stopCharging() {
    if (confirm('Ladung stoppen und zur√ºck zur internen Steuerung?')) {
        showLoading('Stoppe Ladung...');
        
        fetch('api/control', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'stop_charging'})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            showNotification('success', 'Ladung gestoppt');
            updateStatus();
        })
        .catch(error => {
            hideLoading();
            showNotification('error', 'Fehler beim Stoppen');
            console.error(error);
        });
    }
}

function autoMode() {
    showLoading('Aktiviere Automatik...');

    fetch('api/control', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'auto_mode'})
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        showNotification('success', 'Automatik-Modus aktiviert');
        updateStatus();
    })
    .catch(error => {
        hideLoading();
        showNotification('error', 'Fehler beim Aktivieren der Automatik');
        console.error(error);
    });
}

// v0.2.5 - Toggle automation on/off
function toggleAutomation(enabled) {
    fetch('api/control', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'toggle_automation', enabled: enabled})
    })
    .then(response => response.json())
    .then(data => {
        showNotification('success', enabled ? 'Automatik aktiviert' : 'Automatik deaktiviert');
        updateStatus();
    })
    .catch(error => {
        showNotification('error', 'Fehler beim Umschalten der Automatik');
        console.error(error);
        // Revert toggle on error
        document.getElementById('auto-toggle').checked = !enabled;
    });
}

// v0.2.0: Adjust power during active charging
function adjustPowerIfCharging(power) {
    // Check if currently charging
    fetch('api/status')
        .then(response => response.json())
        .then(data => {
            if (data.inverter.mode === 'manual_charging' || data.inverter.mode === 'auto_charging') {
                // Adjust power
                fetch('api/adjust_power', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({power: parseInt(power)})
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'ok') {
                        showNotification('success', `Ladeleistung auf ${power}W angepasst`);
                    } else {
                        showNotification('error', 'Fehler beim Anpassen der Leistung');
                    }
                })
                .catch(error => {
                    console.error('Error adjusting power:', error);
                    showNotification('error', 'Fehler beim Anpassen der Leistung');
                });
            }
        })
        .catch(error => console.error('Error checking status:', error));
}

// v0.3.2 - Manual charging plan recalculation
function recalculatePlan() {
    showLoading('Berechne Ladeplan...');

    fetch('api/recalculate_plan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'ok') {
            showNotification('success', 'Ladeplan neu berechnet!');
            // Wait a moment, then update status to show new plan
            setTimeout(() => {
                updateStatus();
            }, 500);
        } else {
            showNotification('error', 'Fehler bei der Berechnung');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('error', 'Fehler bei der Berechnung');
        console.error(error);
    });
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    clearInterval(refreshInterval);
});
</script>
{% endblock %}