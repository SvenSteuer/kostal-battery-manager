name: Kostal Battery Manager
version: "0.3.3"
slug: kostal_battery_manager
description: "Intelligente Batteriesteuerung f端r Kostal Plenticore Plus mit Tibber-Optimierung"
url: "https://github.com/SvenSteuer/kostal-battery-manager"
arch:
  - aarch64
  - amd64
  - armhf
  - armv7
  - i386
init: false
startup: application
boot: auto
host_network: true
ingress: true
ingress_port: 8099
ingress_stream: false
panel_icon: mdi:battery-charging
panel_title: Battery Manager
hassio_api: true
homeassistant_api: true
privileged:
  - SYS_RAWIO

options:
  inverter_ip: "192.168.80.76"
  inverter_port: 1502
  installer_password: ""
  master_password: ""
  max_charge_power: 3900
  battery_capacity: 10.6
  log_level: "info"
  control_interval: 30
  enable_tibber_optimization: true
  price_threshold: 0.85
  battery_power_sensor: "sensor.zwh8_8500_battery_power"
  battery_voltage_sensor: ""
  tibber_price_sensor: "sensor.tibber_prices"
  tibber_price_level_sensor: "sensor.tibber_price_level_deutsch"
  auto_optimization_enabled: true
  # v0.2.5 - Automation Parameters
  auto_pv_threshold: 5.0
  auto_charge_below_soc: 95
  auto_safety_soc: 20
  # PV Production Sensors (v0.2.1 - beide Dachausrichtungen)
  pv_power_now_roof1: "sensor.power_production_now_roof1"
  pv_power_now_roof2: "sensor.power_production_now_roof2"
  pv_remaining_today_roof1: "sensor.energy_production_today_remaining_roof1"
  pv_remaining_today_roof2: "sensor.energy_production_today_remaining_roof2"
  pv_production_today_roof1: "sensor.energy_production_today_roof1"
  pv_production_today_roof2: "sensor.energy_production_today_roof2"
  pv_production_tomorrow_roof1: "sensor.energy_production_tomorrow_roof1"
  pv_production_tomorrow_roof2: "sensor.energy_production_tomorrow_roof2"
  pv_next_hour_roof1: "sensor.energy_next_hour_roof1"
  pv_next_hour_roof2: "sensor.energy_next_hour_roof2"
  # v0.3.0 - Tibber Smart Charging
  tibber_price_threshold_1h: 8  # Prozent: Preisanstieg zur vorherigen Stunde
  tibber_price_threshold_3h: 8  # Prozent: 3h Block Vergleich
  charge_duration_per_10_percent: 18  # Minuten pro 10% SOC
  min_soc: 20  # Sicherheits-Minimum SOC
  max_soc: 95  # Ziel-SOC f端r Ladung
  # OPTIONAL: input_datetime Helfer f端r HA-Integration
  # Diese m端ssen in Home Assistant erstellt werden:
  # In configuration.yaml:
  #   input_datetime:
  #     tibber_geplantes_ladeende:
  #       name: "Tibber Geplantes Ladeende"
  #       has_date: true
  #       has_time: true
  #     tibber_geplanter_ladebeginn:
  #       name: "Tibber Geplanter Ladebeginn"
  #       has_date: true
  #       has_time: true
  # Dann werden diese automatisch mit den berechneten Zeiten aktualisiert
  input_datetime_planned_charge_end: "input_datetime.tibber_geplantes_ladeende"
  input_datetime_planned_charge_start: "input_datetime.tibber_geplanter_ladebeginn"

schema:
  inverter_ip: str
  inverter_port: port
  installer_password: password
  master_password: password
  max_charge_power: int(100,10000)
  battery_capacity: float(1.0,100.0)
  log_level: list(debug|info|warning|error)
  control_interval: int(10,300)

  # Tibber Integration
  enable_tibber_optimization: bool
  price_threshold: float(0.5,1.0)

  # Battery SOC Sensor
  battery_soc_sensor: str?

  # v0.2.0 - Battery Sensors
  battery_power_sensor: str?
  battery_voltage_sensor: str?
  tibber_price_sensor: str?
  tibber_price_level_sensor: str?
  auto_optimization_enabled: bool

  # v0.2.5 - Automation Parameters
  auto_pv_threshold: float(0.0,50.0)
  auto_charge_below_soc: int(10,100)
  auto_safety_soc: int(5,50)

  # v0.2.1 - PV Production Sensors (Dual Roof)
  pv_power_now_roof1: str?
  pv_power_now_roof2: str?
  pv_remaining_today_roof1: str?
  pv_remaining_today_roof2: str?
  pv_production_today_roof1: str?
  pv_production_today_roof2: str?
  pv_production_tomorrow_roof1: str?
  pv_production_tomorrow_roof2: str?
  pv_next_hour_roof1: str?
  pv_next_hour_roof2: str?

  # v0.3.0 - Tibber Smart Charging
  tibber_price_threshold_1h: int(1,50)
  tibber_price_threshold_3h: int(1,50)
  charge_duration_per_10_percent: int(5,60)
  min_soc: int(5,50)
  max_soc: int(50,100)
  input_datetime_planned_charge_end: str?
  input_datetime_planned_charge_start: str?

map:
  - data:rw
